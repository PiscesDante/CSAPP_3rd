# Lecture 21. Network Programming: Part I

这个章节中的目标是 **<u>能真正理解和熟练的编写网络软件</u>** 。

## 「客户端 - 服务器」传输

**<u>绝大多数网络应用是基于「客户端 - 服务器」模型编写的</u>** ：

*   一个服务端进程和若干个客户端进程；
*   服务器管理着一些资源；
*   服务器通过操作或者管理资源来为客户端提供服务；
*   服务器通过客户端的请求来工作（类似于自动售货机）；

## 网络主机的硬件组织

对于计算机来说网络像是一个输入输出系统，而 UNIX 中关于网络的 API 让其看起来像是一个「文件」。当想要通过网络来传送数据的时候，必须向一个叫做网络的虚拟文件中写入数据，如果想要读取从网络中传输来的数据，那么同样必须读取这个叫做网络的虚拟文件。

目前的情况是，将网络抽象成一个能够被读写的文件已成为操作系统的共识；

## 计算机网络

网络是一些被称为主机的合集，网络上的主机可以通过一些特定的通信手段来交换数据；

而术语 internet 表示的是网络所构成的网络，而首字母大写的 Internet 则表示的是全球最大的那个互联网。

## 网络底层：以太网组件

**<u>以太网最核心的组成部分就是若干个主机，以有线的方式连接在一个集线器（Hub）上</u>** 。无论什么设备连接在集线器上，它所发送的信息都会被广播到其他在这个集线器上的任何机器上。 Hub 本质上是一个广播网络。

## 下一层：桥接的以太网组件

可以说集线器是广播式的设备，而交换机（ Switch ）是点对点的数据交换设备。一般来说，由集线器组成的网络通过交换机（路由器）将组成更大的网络。

## 下一层：互连网

**<u>使用路由器连接起来的网络被称为互连网</u>** 。

## 网络协议简述

**<u>网络协议作为一种软件运行在每个主机和路由器上</u>** 。

*   协议就是一种规则，这个规则描述了数据的传输方式；
*   这个协议必须能在不同的网络之间无缝适配；

## 网络协议是做什么的

**<u>提供一个命名规则</u>** ：

*   网络协议定义一个「主机地址」的特殊格式；
*   每个主机或者路由器被至少分配一个网络地址来在网络中标识自己；

**<u>提供一个数据传递机制</u>** ：

*   一个互连网协议定义了标准的数据传输单元（Packet ，也就是数据包）；数据包的大小一般是 1000 ~ 2000 字节。
*   数据包包括了「包头」和「有效数据」；
    *   包头：包括了关于数据包本身的信息，包括数据包的大小，目标主机地址等等；
    *   有效数据：也就是我们需要传递的信息；

## 互联网

**<u>互联网使用最基本的 TCP/IP 协议家族</u>** ：

*   IP（Internet Protocol）：提供最基本的命名规则和「端到端」之间不可靠的「数据包」传输能力，也就是说，包传丢了就不管了。
*   UDP（Unreliable Datagram Protocol）：配合使用 IP 来提供「进程到进程」之间的不可靠数据传输；也是个数据传丢了就不管的。
*   TCP（Transmission Control Protocol）：配合使用 IP 来提供「进程到进程」之间可靠的数据传输；数据传丢了得通知源重新传一次。超过 99% 的网络流量都通过 TCP 协议来传输，毕竟数据包不能传丢了就算了。

每一个进程可以建立若干个网络传输「文件」，这些文件有些是用来发送数据的，有些是用来接收数据的。这个思想的实现就是计算机网络系统中的 Socket 。

## 程序员视角的下的互联网

*   **<u>互联网中的主机被映射为一个的 32 位的 IP 地址</u>** ：比如说 128.2.203.179 ；
*   一些 IP 地址又被映射成了一个「域名」：比方说 128.2.203.179 被映射成了 www.cs.cmu.edu ；
*   一个主机上的进程可以通过「连接」来和另一个主机上的进程通信；

## （1）IP 地址

**<u>32 位的 IP 地址存储在一个 IP 地址结构中</u>** ：

*   IP 地址在内存中总是以大端法进行存储；

```C
/* INTERNET ADDRESS STRUCTURE */
typedef struct {
    uint32_t s_addr; /* NETWORK BYTE ORDER (BIG-ENDIAN) */
} in_addr;
```

## IP 地址的转化方法

```
0x 80.02.C2.F2 ===> 128.2.194.242
```

## （2）互联网域名



##域名系统（ DNS ） 

**<u>互联网本身维护着一个巨大的数据库（分布式系统），里面存放着 IP 地址和域名的对应关系，这个分布式数据库就是所谓的「域名解析系统」</u>** 。

概念上来说，程序员可以将 DNS 数据库看作一个主机入口集合（因为要将域名转换成 IP 地址才能够对主机进行访问）；

## DNS 映射的性质

我们可以使用 `nslookup` 命令在 Linux 系统上来查找一个域名所对应的 IP 地址。这个指令给定一个域名将返回一个 IP 地址，给定一个 IP 地址会返回一个域名；

域名和 IP 地址很可能不是一一对应的，一个域名可能有很多个对应的 IP 地址，并且一个地址也可能对应不同的域名。

有些合法的域名也可能没有任何对应的 IP 地址。

## （3）互联网连接

**<u>客户端和服务器通过「连接」来互相发送字节流，每个连接</u>** ：

*   连接是点对点的：连接的两端各有一个进程；
*   全双工通信：数据可同时双向传输；
*   可靠性：目标主机会按照源主机发送的字节顺序收到其发送的字节流。

**<u>套接字 Socket 是连接中的一个端点</u>** ：

*   套接字地址的形式是： `IPAddress:Port`  ;

**<u>端口是一个 16 位整数，用来标识一个特定的进程。也可以说，一个端口号代表主机上的一个特定的服务</u>** ：

*   临时端口：只会在一段时间内，这个临时端口是客户端或者服务器进程自己指定的；
*   知名端口：比方说 80 端口就是 HTTP 的默认端口，这种知名端口最好不要被其他进程占用，因为会导致默认服务没有办法使用。

## 连接的解构

**<u>一个连接被一对套接字来唯一的标识</u>** ：

```
(client_IPAddress:client_port, server_IPAddress:server_port)
```

## 使用端口来标识服务



## 套接字接口编程



## 套接字（Socket）

**<u>什么是 Socket</u>** ？虽然现在已经将其翻译为套接字，但是这个翻译实在是糟糕的很，还不如不翻译……

*   对于操作系统来说，一个 Socket 是一个连接的端点；
*   对于应用程序来说， Socket 是一个文件描述符，应用程序可以通过 Socket 这个「文件描述符」访问 Socket 对象，也就是一个「文件」，通过向文件中写入或者读取来获取网络连接的数据。
*   **<u>谨记：所有 Unix I/O 设备，包括网络，都被抽象建模成了「文件」</u>** 。

**<u>客户端和服务器通过读写 Socket 这个文件描述符来同对方进行通信</u>** 。

**<u>普通文件描述符和 Socket 的主要区别就是应用打开两者的方式</u>** 。

## Socket 地址结构